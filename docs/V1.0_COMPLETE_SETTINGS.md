# Version 1.0 - Complete Settings Documentation

**Date:** 2026-01-15 (Updated)  
**Status:** ‚úÖ Production Ready - All Components Working

---

## üéØ Overview

This document contains the complete working configuration for Version 1.0 of the moOde Audio Player system with:
- ‚úÖ Portrait mode display (rotated to landscape 1280x400)
- ‚úÖ PeppyMeter enabled (blue skin, audio visualization)
- ‚úÖ CamillaDSP enabled (Bose Wave filters - 20 bands)
- ‚úÖ HiFiBerry AMP100 audio output
- ‚úÖ HDMI audio completely disabled
- ‚úÖ Complete audio chain working
- ‚úÖ Default curves removed (only Bose Wave filters active)
- ‚úÖ Web interface pages working (database values fixed)

---

## üñ•Ô∏è DISPLAY SETTINGS

### moOde Database Settings
```sql
hdmi_scn_orient = portrait
local_display = 1
peppy_display = 0  (enabled for audio, not displayed)
peppy_display_type = meter
```

### Display Configuration
- **Hardware:** Waveshare 7.9" HDMI display (400x1280 portrait)
- **Display Mode:** Portrait hardware rotated to landscape (1280x400)
- **Rotation:** Left (90¬∞ counter-clockwise)
- **HDMI Port:** HDMI-2 (Pi 5)

### .xinitrc Configuration
**Location:** `/home/andre/.xinitrc`

**Portrait Rotation Section:**
```bash
if [ "$HDMI_SCN_ORIENT" = "portrait" ]; then
    # Detect which HDMI port is actually connected
    HDMI_OUT=$(xrandr --query 2>/dev/null | awk '/^HDMI-[0-9]+ connected/ {print $1; exit}')
    [ -z "$HDMI_OUT" ] && HDMI_OUT="HDMI-2"
    
    DISPLAY=:0 xrandr --output "$HDMI_OUT" --rotate left
    SCREEN_RES="1280,400"
fi
```

**Key Points:**
- Dynamically detects connected HDMI port (HDMI-2 on Pi 5)
- Rotates display left to convert 400x1280 ‚Üí 1280x400
- Sets SCREEN_RES to landscape dimensions (1280,400)

---

## üîä AUDIO SETTINGS

### moOde Database Settings
```sql
cardnum = 1  (HiFiBerry AMP100)
i2sdevice = HiFiBerry AMP100
adevname = HiFiBerry AMP100
alsa_output_mode = plughw
volume_control = Software
camilladsp = bose_wave_filters.yml
cdsp_fix_playback = Yes
```

**Note:** Database values must match actual configuration for web interface pages to load correctly.

### Audio Hardware
- **Card 0:** Loopback (ALSA loopback device)
- **Card 1:** HiFiBerry AMP100 (snd_rpi_hifiberry_dacplus)
- **Hardware Volume Control:** Softvol (100%)

### Audio Chain
```
MPD ‚Üí _audioout ‚Üí loopback:0,0
  ‚Üí CamillaDSP (captures from loopback:1,0)
  ‚Üí _peppyout ‚Üí plughw:1,0 (HiFiBerry AMP100)
```

### ALSA Configuration Files

#### `/etc/alsa/conf.d/_audioout.conf`
```alsa
pcm._audioout {
    type plug
    slave.pcm "loop:Loopback,0,0"
}
```

#### `/etc/alsa/conf.d/_peppyout.conf`
```alsa
pcm._peppyout {
    type plug
    slave.pcm "plughw:1,0"
}
```

#### `/etc/alsa/conf.d/99-default.conf`
```alsa
pcm.default {
    type plug
    slave.pcm "_audioout"
}
```

### MPD Configuration
**Location:** `/etc/mpd.conf`

```conf
audio_output {
    type "alsa"
    name "My ALSA Device"
    device "_audioout"
    mixer_type "software"
}
```

### CamillaDSP Configuration
**Location:** `/usr/share/camilladsp/working_config.yml`

**Config:** Bose Wave Room EQ Filters (20 filter bands)

```yaml
description: Room EQ Import - Bose Wave Filters
devices:
  adjust_period: 10
  capture:
    type: Alsa
    channels: 2
    device: hw:Loopback,1,0
    format: S24LE
  chunksize: 1024
  enable_rate_adjust: false
  playback:
    type: Alsa
    channels: 2
    device: _peppyout
    format: S24LE
  queuelimit: 1
  samplerate: 44100
  silence_threshold: 0
  silence_timeout: 0
  target_level: 0
  volume_ramp_time: 150
filters:
  peqgain: (Gain control)
  band_01 through band_20: (20 biquad filter bands)
    - Frequency range: 36.35 Hz to 7500 Hz
    - Types: Lowshelf, Peaking, Highshelf
    - Optimized for Bose Wave speaker response
mixers:
  stereo: (2-channel stereo mixer)
pipeline:
  - stereo mixer
  - channel 0 filters (peqgain + 20 bands)
  - channel 1 filters (peqgain + 20 bands)
title: Bose Wave Room EQ Filters
```

**Key Points:**
- Captures from ALSA loopback device (hw:Loopback,1,0)
- Plays back to _peppyout (which routes to HiFiBerry)
- **20 filter bands** for Bose Wave speaker optimization
- **Default curves removed** - only Bose Wave filters active
- Database setting: `camilladsp = bose_wave_filters.yml`

### PeppyMeter Configuration
**Location:** `/etc/peppymeter/config.txt`

```ini
meter = blue
meter.folder = 1280x400
screen.width = 1280
screen.height = 400
random.meter.interval = 0
```

**Key Points:**
- Always uses blue skin
- Screen dimensions: 1280x400 (landscape)
- Random meter switching disabled

---

## üîß SYSTEM CONFIGURATION

### Boot Configuration
**Location:** `/boot/firmware/config.txt`

**Audio Settings:**
```
dtparam=audio=off
dtoverlay=vc4-kms-v3d-pi5,noaudio
```

**Key Points:**
- HDMI audio completely disabled
- KMS overlay with noaudio flag
- Prevents IEC958/HDMI audio conflicts

### ALSA Loopback Module
**Load on Boot:** `/etc/modules-load.d/alsa-loopback.conf`

```
snd-aloop
```

**Key Points:**
- ALSA loopback module loads automatically on boot
- Required for MPD ‚Üí CamillaDSP audio routing

### IP Forwarding
**Status:** ‚ö†Ô∏è Currently disabled (0)
**Should be:** 1 (enabled) for WireGuard

**To Enable:**
```bash
# Temporary
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

# Permanent
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

---

## üéõÔ∏è SERVICE CONFIGURATION

### Service Status (All Active)
- ‚úÖ `mpd.service` - Music Player Daemon
- ‚úÖ `camilladsp.service` - Audio processing
- ‚úÖ `peppymeter.service` - Audio visualization
- ‚úÖ `localdisplay.service` - X server and Chromium

### Service Dependencies
- `localdisplay.service` starts X server and Chromium
- `mpd.service` outputs to `_audioout`
- `camilladsp.service` processes audio from loopback
- `peppymeter.service` receives audio for visualization

---

## üåê NETWORK SETTINGS

### Local Network
- **Ethernet (eth0):** 192.168.2.3/24
- **Hostname:** moodepi5.local
- **SSH User:** andre
- **SSH Password:** 0815

### WireGuard VPN
- **Server VPN IP:** 10.8.0.1/24
- **Client VPN IP:** 10.8.0.2/32
- **Port:** 51820/UDP
- **Status:** Active (IP forwarding needs to be enabled)

See `docs/WIREGUARD_COMPLETE_SETTINGS.md` for full WireGuard configuration.

---

## üìã QUICK REFERENCE

### Display
| Setting | Value |
|---------|-------|
| Hardware Orientation | Portrait (400x1280) |
| Displayed Orientation | Landscape (1280x400) |
| Rotation | Left (90¬∞ CCW) |
| HDMI Port | HDMI-2 |
| WebUI Enabled | Yes (1) |
| PeppyMeter Display | No (0) - audio only |

### Audio
| Setting | Value |
|---------|-------|
| Audio Card | 1 (HiFiBerry AMP100) |
| MPD Device | _audioout |
| Audio Chain | MPD ‚Üí loopback ‚Üí CamillaDSP ‚Üí PeppyMeter ‚Üí AMP100 |
| Volume Control | Software |
| CamillaDSP | Enabled (Bose Wave filters - 20 bands) |
| PeppyMeter | Enabled (blue skin) |
| HDMI Audio | Disabled |

### Services
| Service | Status | Auto-start |
|---------|--------|------------|
| MPD | ‚úÖ Active | ‚úÖ Yes |
| CamillaDSP | ‚úÖ Active | ‚úÖ Yes |
| PeppyMeter | ‚úÖ Active | ‚úÖ Yes |
| LocalDisplay | ‚úÖ Active | ‚úÖ Yes |
| WireGuard | ‚úÖ Active | ‚úÖ Yes |

---

## üõ†Ô∏è SETUP SCRIPTS

### Main Setup Script
**Location:** `scripts/audio/fix-portrait-peppy-camilla-v1.0.sh`

This script configures:
- Portrait mode display
- PeppyMeter (blue skin, 1280x400)
- CamillaDSP (with loopback routing)
- Complete audio chain

### Audio Chain Fix Script
**Location:** `scripts/audio/fix-audio-chain.sh`

This script ensures:
- HiFiBerry AMP100 detection
- Correct ALSA routing
- MPD device configuration
- Volume settings

---

## ‚ö†Ô∏è KNOWN ISSUES & FIXES

### Issue: Sound Settings Page Not Loading
**Problem:** Web interface sound/audio settings page fails to load  
**Solution:** Database values must match actual configuration:
- `cardnum = 1` (not empty)
- `adevname = HiFiBerry AMP100` (not "Pi HDMI 1")
- `alsa_output_mode = plughw` (not "iec958")
- `camilladsp = bose_wave_filters.yml`  
**Status:** ‚úÖ Fixed - Database values updated to match configuration

### Issue: IP Forwarding Disabled
**Problem:** WireGuard clients cannot access internet  
**Solution:** Enable IP forwarding (see System Configuration section)  
**Status:** Needs to be enabled

### Issue: Display White Screen
**Problem:** Chromium shows white screen instead of login  
**Solution:** Ensure `local_display = 1` and `peppy_display = 0`  
**Status:** Fixed

---

## ‚úÖ VERIFICATION CHECKLIST

### Display
- [x] Display shows 1280x400 landscape
- [x] Rotation working (portrait ‚Üí landscape)
- [x] WebUI visible (not white screen)
- [x] PeppyMeter configured but not displayed

### Audio
- [x] MPD playing audio
- [x] CamillaDSP processing
- [x] PeppyMeter receiving audio
- [x] Sound output to HiFiBerry AMP100
- [x] HDMI audio disabled

### Services
- [x] All services active
- [x] Services start on boot
- [x] No errors in logs

### Network
- [x] Local network working
- [x] WireGuard active (IP forwarding needs fix)

---

## üìù NOTES

1. **Database vs ALSA Configs:** The moOde database may show old values, but the actual audio routing is controlled by ALSA configuration files in `/etc/alsa/conf.d/`.

2. **Card Numbers:** After reboot, card numbers may change. Always verify with `aplay -l` and update `_peppyout.conf` if needed.

3. **Display Rotation:** The `.xinitrc` dynamically detects the HDMI port, so it works even if the port changes.

4. **ALSA Loopback:** The loopback module must be loaded for the audio chain to work. It's configured to load on boot.

5. **Volume Levels:** 
   - Hardware volume: 100% (Softvol)
   - Software volume: Controlled via MPD (typically 50-70%)

---

## üîÑ RESTORATION PROCEDURE

To restore these settings on a fresh install:

1. **Display:**
   - Set `hdmi_scn_orient = portrait` in database
   - Update `.xinitrc` with rotation logic (detect HDMI port, rotate left)
   - Set `SCREEN_RES = "1280,400"`

2. **Audio:**
   - Disable HDMI audio in `config.txt` (`dtparam=audio=off`, `dtoverlay=vc4-kms-v3d-pi5,noaudio`)
   - Create ALSA configs (`_audioout.conf`, `_peppyout.conf`)
   - Configure CamillaDSP (`working_config.yml`)
   - Configure PeppyMeter (`config.txt` - blue skin, 1280x400)
   - Enable ALSA loopback module on boot

3. **Services:**
   - Enable and start: mpd, camilladsp, peppymeter, localdisplay
   - Verify all services are active

4. **Database:**
   - Update audio settings (cardnum, i2sdevice, adevname)
   - Set display settings (hdmi_scn_orient, local_display, peppy_display)

---

**Last Updated:** 2026-01-15  
**Version:** 1.0  
**Status:** ‚úÖ Production Ready

---

## üìù RECENT UPDATES (2026-01-15)

### Bose Wave Filters
- ‚úÖ Replaced flat/no-filter config with Bose Wave Room EQ filters
- ‚úÖ 20 filter bands configured (36Hz - 7.5kHz)
- ‚úÖ Optimized for Bose Wave speaker response
- ‚úÖ Default curves removed from `/usr/share/camilladsp/configs/`

### Database Values Fixed
- ‚úÖ `cardnum = 1` (was empty)
- ‚úÖ `adevname = HiFiBerry AMP100` (was "Pi HDMI 1")
- ‚úÖ `alsa_output_mode = plughw` (was "iec958")
- ‚úÖ `camilladsp = bose_wave_filters.yml` (was "V3-Flat.yml")
- ‚úÖ Sound settings page now loads correctly

### Configuration Files
- ‚úÖ `working_config.yml` - Direct file (not symlink) with Bose Wave filters
- ‚úÖ All default curve configs removed
- ‚úÖ Database values match actual ALSA configuration
