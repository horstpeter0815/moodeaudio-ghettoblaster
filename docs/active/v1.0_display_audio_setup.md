# Ghetto Blaster v1.0 - Display & Audio Setup Documentation

**Last Updated:** January 6, 2026  
**System:** Ghetto Blaster (Raspberry Pi 5)  
**AI Assistant:** Ghetto AI (Open WebUI on Mac)

## Overview

This document describes the complete working display and audio configuration for the Ghetto Blaster system. This setup has been tested and verified as of January 2026.

### Hardware Components

- **Display:** Waveshare 7.9" HDMI Touchscreen (400x1280 native, rotated to 1280x400 landscape)
- **Audio:** HiFiBerry AMP100 (2x50W Class D amplifier, I2S interface)
- **System:** Raspberry Pi 5 running moOde Audio
- **AI Integration:** Ghetto AI (Open WebUI with Ollama) running on Mac

---

## Display Configuration

### Boot-Level Configuration (`/boot/firmware/config.txt`)

The display is configured at boot time with the following key settings:

```bash
hdmi_force_hotplug:0=1
hdmi_force_hotplug:1=1
hdmi_enable_4kp60=0
dtoverlay=vc4-kms-v3d,noaudio
display_auto_detect=1
hdmi_drive=2
hdmi_blanking=1
hdmi_force_hotplug=1
hdmi_group=0
```

**Key Points:**
- `dtoverlay=vc4-kms-v3d,noaudio` - Enables KMS (Kernel Mode Setting) for proper display handling, `noaudio` prevents HDMI audio conflicts
- `hdmi_force_hotplug=1` - Forces HDMI detection even if no EDID is present
- `display_auto_detect=1` - Allows automatic display detection

### X11 Display Rotation (`.xinitrc`)

The display rotation is handled in `/home/andre/.xinitrc` which is executed when X11 starts.

**Location:** `/home/andre/.xinitrc`

**Key Logic:**
1. Detects HDMI output (HDMI-1 or HDMI-2) dynamically
2. Waits up to 10 seconds for HDMI to be detected
3. Applies rotation sequence:
   - First: Reset to normal rotation
   - Second: Set native mode (400x1280)
   - Third: Rotate left to achieve 1280x400 landscape

**Critical Code Section:**
```bash
# HDMI screens (default is landscape)
if [ $HDMI_SCN_ORIENT = "portrait" ]; then
    SCREEN_RES=$(echo $SCREEN_RES | awk -F"," '{print $2","$1}')
    HDMI_OUT=""
    for i in {1..10}; do
        HDMI_OUT=$(DISPLAY=:0 xrandr --query 2>/dev/null | awk '/^HDMI-[0-9]+ connected/{print $1; exit}')
        [ -n "${HDMI_OUT:-}" ] && break
        sleep 1
    done
    [ -z "${HDMI_OUT:-}" ] && HDMI_OUT=HDMI-1
    DISPLAY=:0 xrandr --output "$HDMI_OUT" --rotate normal 2>/dev/null || true
    sleep 1
    DISPLAY=:0 xrandr --output "$HDMI_OUT" --mode 400x1280 2>/dev/null || true
    sleep 1
    DISPLAY=:0 xrandr --output "$HDMI_OUT" --rotate left 2>/dev/null || true
fi
```

**Why This Works:**
- The display hardware is 400x1280 (portrait), but we want 1280x400 (landscape)
- The rotation sequence ensures the display is properly initialized before rotation
- Dynamic HDMI detection handles cases where the display connects to HDMI-1 or HDMI-2

### Display Applications

The `.xinitrc` also manages which application displays on the screen:

1. **PeppyMeter** (if enabled in moOde):
   - Shows VU meters when `peppy_display=1` in moOde database
   - Located at `/opt/peppymeter/`
   - Uses skin folder `1280x400-moode` (configured in `/etc/peppymeter/config.txt`)

2. **Chromium (Web UI)**:
   - Launches after PeppyMeter exits (when screen is touched)
   - Displays moOde web interface or Room Correction Wizard
   - URL controlled by `local_display_url` in moOde database

**Display URL Management:**
- Default: `http://localhost/` (moOde main UI)
- Wizard: `http://localhost/wizard/display.html` (Room Correction Wizard)
- Stored in moOde database: `cfg_system.local_display_url`

---

## Audio Configuration

### Hardware Setup

**HiFiBerry AMP100 Configuration:**
- **Device Tree Overlay:** `dtoverlay=hifiberry-amp100` in `/boot/firmware/config.txt`
- **ALSA Card:** `sndrpihifiberry` (card 0)
- **Max Volume:** 20% (79% of 255 = 202) - **CRITICAL: Never exceed 75% (191) for safety**
- **Auto-Mute:** Enabled via dtoverlay parameter

**Current Volume Settings:**
```
Playback channels: Front Left - Front Right
Limits: Playback 0 - 255
Front Left: Playback 202 [79%] [-2.50dB] [on]
Front Right: Playback 202 [79%] [-2.50dB] [on]
```

**⚠️ VOLUME SAFETY WARNING:**
- Maximum safe volume: **191 (75%)**
- Current volume: **202 (79%)** - **REDUCE TO 191 OR BELOW**
- Higher volumes can damage speakers and amplifier

### ALSA Configuration Chain

The audio routing follows this path:

```
MPD → _audioout → peppy → _peppyout → camilladsp → HiFiBerry DAC
```

#### 1. `_audioout.conf` (`/etc/alsa/conf.d/_audioout.conf`)

Routes audio to PeppyMeter for VU meter display:

```alsa
pcm._audioout {
    type copy
    slave.pcm "peppy"
}
```

#### 2. `_peppyout.conf` (`/etc/alsa/conf.d/_peppyout.conf`)

Routes PeppyMeter output through CamillaDSP for EQ processing:

```alsa
pcm._peppyout {
    type copy
    slave.pcm "camilladsp"
}
```

#### 3. `camilladsp.conf` (`/etc/alsa/conf.d/camilladsp.conf`)

Configures CamillaDSP as an ALSA plugin:

```alsa
pcm.camilladsp {
    type cdsp
    cpath "/usr/local/bin/camilladsp"
    config_out "/usr/share/camilladsp/working_config.yml"
    config_cdsp 1
    min_channels 1
    max_channels 8
    rates = [44100, 48000, 88200, 96000, 176400, 192000, 352800, 384000]
    cargs [
        -s "/var/lib/cdsp/statefile.yml"
    ]
}
```

**Key Points:**
- Uses CamillaDSP configuration file: `/usr/share/camilladsp/working_config.yml`
- Supports sample rates from 44.1kHz to 384kHz
- State file location: `/var/lib/cdsp/statefile.yml`

### CamillaDSP Configuration

**Location:** `/usr/share/camilladsp/working_config.yml`

**Current Configuration:**
- **Input:** Stdin (S32LE, 2 channels, 44100 Hz)
- **Output:** ALSA device `default:CARD=sndrpihifiberry` (direct to HiFiBerry DAC)
- **Chunk Size:** 4096 samples
- **Queue Limit:** 1

**Filter Pipeline:**
1. **peqgain:** Gain stage (-6 dB)
2. **band_1 through band_5:** Parametric EQ bands (currently all set to 0 dB gain - neutral)

**Critical Schema Fix:**
- **Correct:** `channels: 2` (in pipeline section)
- **Incorrect:** `channel: 2` (causes CamillaDSP to crash)

**Playback Device:**
- **Current:** `default:CARD=sndrpihifiberry` (direct DAC output)
- **Previous (broken):** `peppy` (caused routing conflicts)

### Audio Routing for Room Correction Wizard

When the Room Correction Wizard is active:

1. **Pink Noise Generation:**
   - Uses `speaker-test` directly to HiFiBerry DAC
   - Command: `speaker-test -t pink -c 2 -r 44100 -l 0 -D plughw:CARD=sndrpihifiberry,DEV=0`
   - PID stored in: `/tmp/pink_noise.pid`
   - Log stored in: `/tmp/pink_noise.log`

2. **Display Switching:**
   - Temporarily disables PeppyMeter (`peppy_display=0`)
   - Enables local display (`local_display=1`)
   - Sets `local_display_url` to wizard URL
   - Restores original settings after measurement

---

## System Services

### Display Service

**Service:** `localdisplay.service`
- **Location:** `/lib/systemd/system/localdisplay.service`
- **Purpose:** Starts X11 server and Chromium browser
- **Triggers:** `.xinitrc` execution
- **Restart Command:** `sudo systemctl restart localdisplay.service`

### Audio Services

1. **MPD (Music Player Daemon):**
   - Main audio playback engine
   - Routes through ALSA chain: `_audioout → peppy → _peppyout → camilladsp → DAC`

2. **CamillaDSP:**
   - Digital signal processing (EQ, filters)
   - Managed via ALSA plugin system
   - Configuration: `/usr/share/camilladsp/working_config.yml`

3. **PeppyMeter:**
   - VU meter visualization
   - Receives audio via `_audioout` ALSA device
   - Outputs via `_peppyout` to CamillaDSP

---

## Room Correction Wizard

### Overview

The Room Correction Wizard allows acoustic measurement and EQ adjustment using an iPhone microphone.

**Backend:** `/var/www/command/room-correction-wizard.php`  
**Frontend:** `/var/www/wizard/display.html`  
**Control Script:** `/var/www/wizard/js/wizard-control.js`

### Measurement Process

1. **Start Measurement:**
   - User presses "Start Measurement" on iPhone
   - iPhone requests microphone permission (must be first action on iPhone Safari)
   - Backend starts pink noise via `speaker-test`
   - Display switches to wizard graph view

2. **Live Measurement:**
   - iPhone captures audio and sends frequency response data
   - Data stored in `/tmp/wizard_measurement_data.json`
   - Display shows live frequency response graph

3. **Stop Measurement:**
   - Backend stops pink noise (kills `speaker-test` process)
   - Display restores to PeppyMeter or moOde UI

### Temporary Files

**Location:** `/tmp/`

- `wizard_measurement_data.json` - Live measurement data from iPhone
- `pink_noise.pid` - Process ID of running pink noise
- `pink_noise.log` - Log output from `speaker-test`
- `moode_display_url_backup.txt` - Backup of original `local_display_url`

**Note:** These files are temporary and should be cleaned up after wizard use.

---

## Integration with Ghetto AI

**AI System:** Ghetto AI (Open WebUI with Ollama)  
**Location:** Mac (separate from Pi)  
**Purpose:** AI assistant for system configuration, troubleshooting, and documentation

**Knowledge Base:**
- This documentation is part of the Ghetto AI knowledge base
- Uploaded to Open WebUI RAG for AI learning
- Enables AI to understand display/audio setup

**Agents:**
1. **moOde Network Config Agent** - Network configuration assistance
2. **moOde Documentation Generator** - Code documentation generation
3. **moOde Build Agent** - Build and deployment management

---

## Verification Commands

### Display Verification

```bash
# Check current display resolution
DISPLAY=:0 xrandr | grep HDMI

# Check framebuffer resolution
cat /sys/class/graphics/fb0/virtual_size

# Check X11 screen dimensions
DISPLAY=:0 xdpyinfo | grep dimensions
```

### Audio Verification

```bash
# Check ALSA card
aplay -l

# Check current volume
amixer -c 0 sget Digital

# Check CamillaDSP status
systemctl status camilladsp

# Test audio output
speaker-test -t pink -c 2 -r 44100 -D plughw:CARD=sndrpihifiberry,DEV=0
```

### Service Status

```bash
# Check display service
systemctl status localdisplay.service

# Check MPD status
systemctl status mpd

# Check PeppyMeter (if running)
ps aux | grep peppymeter
```

---

## Troubleshooting

### Display Issues

**Problem:** Display shows wrong orientation or is cut off  
**Solution:**
1. Check HDMI output: `DISPLAY=:0 xrandr | grep connected`
2. Verify `.xinitrc` rotation sequence
3. Restart display service: `sudo systemctl restart localdisplay.service`

**Problem:** Display shows wizard instead of PeppyMeter  
**Solution:**
1. Check moOde database: `moodeutl -q "SELECT value FROM cfg_system WHERE param='local_display_url'"`
2. Set to default: `moodeutl -w "UPDATE cfg_system SET value='http://localhost/' WHERE param='local_display_url'"`
3. Restart display service

### Audio Issues

**Problem:** No audio output  
**Solution:**
1. Check CamillaDSP config schema: `grep -A 5 "pipeline:" /usr/share/camilladsp/working_config.yml`
2. Verify `channels:` (not `channel:`) in pipeline section
3. Check playback device: `grep "device:" /usr/share/camilladsp/working_config.yml`
4. Restart MPD: `sudo systemctl restart mpd`

**Problem:** Pink noise doesn't play in wizard  
**Solution:**
1. Check if process is running: `cat /tmp/pink_noise.pid`
2. Check log: `cat /tmp/pink_noise.log`
3. Test direct output: `speaker-test -t pink -c 2 -r 44100 -D plughw:CARD=sndrpihifiberry,DEV=0`

**Problem:** Volume too high (risk of damage)  
**Solution:**
1. **IMMEDIATELY reduce volume:** `amixer -c 0 sset Digital 191` (75% max)
2. Verify: `amixer -c 0 sget Digital`
3. Never exceed 75% (191/255)

---

## Configuration Files Summary

### Critical Files to Preserve

1. **Display:**
   - `/home/andre/.xinitrc` - X11 startup and rotation
   - `/boot/firmware/config.txt` - Boot-level display config

2. **Audio:**
   - `/usr/share/camilladsp/working_config.yml` - CamillaDSP configuration
   - `/etc/alsa/conf.d/camilladsp.conf` - ALSA CamillaDSP plugin
   - `/etc/alsa/conf.d/_peppyout.conf` - PeppyMeter output routing
   - `/etc/alsa/conf.d/_audioout.conf` - Main audio output routing

3. **Wizard:**
   - `/var/www/command/room-correction-wizard.php` - Wizard backend
   - `/var/www/wizard/display.html` - Wizard frontend
   - `/var/www/wizard/js/wizard-control.js` - Wizard control script

4. **Services:**
   - `/lib/systemd/system/localdisplay.service` - Display service

---

## Version History

- **v1.0 (January 6, 2026):** Initial documentation of working configuration
  - Display rotation fixed (dynamic HDMI detection)
  - Audio chain verified (MPD → PeppyMeter → CamillaDSP → DAC)
  - CamillaDSP schema corrected (`channels:` not `channel:`)
  - Volume safety documented (max 75% = 191/255)
  - Room Correction Wizard pink noise generation fixed
  - Ghetto AI integration documented

---

## References

- [moOde Audio Documentation](https://moodeaudio.org/)
- [HiFiBerry AMP100 Documentation](https://www.hifiberry.com/products/amplifiers/amp100/)
- [CamillaDSP Documentation](https://github.com/HEnquist/camilladsp)
- [ALSA Configuration](https://www.alsa-project.org/wiki/Configuration)
- [X11 xrandr Documentation](https://www.x.org/releases/current/doc/man/man1/xrandr.1.xhtml)

---

**Document Maintained By:** Ghetto AI (Open WebUI)  
**For Questions:** Consult Ghetto AI knowledge base or this documentation

