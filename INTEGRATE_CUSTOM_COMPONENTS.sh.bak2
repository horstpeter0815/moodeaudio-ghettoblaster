#!/bin/bash
# Ghettoblaster - Integriert Custom Komponenten in moOde Source
# Bereitet moOde Source für Custom Build vor

LOG_FILE="integrate-custom-components-$(date +%Y%m%d_%H%M%S).log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MOODE_SOURCE="$SCRIPT_DIR/moode-source"
COMPONENTS_DIR="$SCRIPT_DIR/custom-components"

log() {
    echo "[$(date +%H:%M:%S)] $1" | tee -a "$LOG_FILE"
}

echo "=== INTEGRATION: CUSTOM KOMPONENTEN IN MOODE SOURCE ===" | tee -a "$LOG_FILE"

# Prüfe ob moode-source existiert
if [ ! -d "$MOODE_SOURCE" ]; then
    log "❌ moode-source Verzeichnis nicht gefunden: $MOODE_SOURCE"
    exit 1
fi
log "✅ moode-source gefunden: $MOODE_SOURCE"

# Prüfe ob custom-components existiert
if [ ! -d "$COMPONENTS_DIR" ]; then
    log "❌ custom-components Verzeichnis nicht gefunden: $COMPONENTS_DIR"
    exit 1
fi
log "✅ custom-components gefunden: $COMPONENTS_DIR"

log ""
log "=== SCHRITT 1: SERVICES INTEGRIEREN ==="

# Backup vorhandener Services
if [ -f "$MOODE_SOURCE/lib/systemd/system/localdisplay.service" ]; then
    cp "$MOODE_SOURCE/lib/systemd/system/localdisplay.service" \
       "$MOODE_SOURCE/lib/systemd/system/localdisplay.service.backup"
    log "✅ Backup erstellt: localdisplay.service.backup"
fi

# Kopiere Custom Services
log "Kopiere Custom Services..."
cp "$COMPONENTS_DIR/services/localdisplay.service" \
   "$MOODE_SOURCE/lib/systemd/system/" 2>/dev/null && \
   log "✅ localdisplay.service kopiert" || \
   log "⚠️  localdisplay.service bereits vorhanden"

cp "$COMPONENTS_DIR/services/xserver-ready.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ xserver-ready.service kopiert"

cp "$COMPONENTS_DIR/services/ft6236-delay.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ ft6236-delay.service kopiert"

cp "$COMPONENTS_DIR/services/peppymeter.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ peppymeter.service kopiert"

cp "$COMPONENTS_DIR/services/i2c-monitor.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ i2c-monitor.service kopiert"

cp "$COMPONENTS_DIR/services/i2c-stabilize.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ i2c-stabilize.service kopiert"

cp "$COMPONENTS_DIR/services/audio-optimize.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ audio-optimize.service kopiert"

cp "$COMPONENTS_DIR/services/peppymeter-extended-displays.service" \
   "$MOODE_SOURCE/lib/systemd/system/" && \
   log "✅ peppymeter-extended-displays.service kopiert"

# Disable Console Service (verhindert Console auf Display)
cp "$MOODE_SOURCE/lib/systemd/system/disable-console.service" \
   "$MOODE_SOURCE/lib/systemd/system/" 2>/dev/null && \
   log "✅ disable-console.service kopiert" || \
   log "⚠️  disable-console.service bereits vorhanden"

# Fix SSH and Sudoers Service (CRITICAL - runs on every boot)
cp "$COMPONENTS_DIR/services/fix-ssh-sudoers.service" \
   "$MOODE_SOURCE/lib/systemd/system/" 2>/dev/null && \
   log "✅ fix-ssh-sudoers.service kopiert" || \
   log "⚠️  fix-ssh-sudoers.service bereits vorhanden"

# Enable SSH Early Service (CRITICAL - before moOde can disable it)
cp "$COMPONENTS_DIR/services/enable-ssh-early.service" \
   "$MOODE_SOURCE/lib/systemd/system/" 2>/dev/null && \
   log "✅ enable-ssh-early.service kopiert" || \
   log "⚠️  enable-ssh-early.service bereits vorhanden"

# Fix User ID Service (CRITICAL - moOde requires UID 1000)
cp "$COMPONENTS_DIR/services/fix-user-id.service" \
   "$MOODE_SOURCE/lib/systemd/system/" 2>/dev/null && \
   log "✅ fix-user-id.service kopiert" || \
   log "⚠️  fix-user-id.service bereits vorhanden"

# Network IP Fix Service (avoid 142/143 repeater IPs)
cp "$COMPONENTS_DIR/services/fix-network-ip.service" \
   "$MOODE_SOURCE/lib/systemd/system/" 2>/dev/null && \
   log "✅ fix-network-ip.service kopiert" || \
   log "⚠️  fix-network-ip.service bereits vorhanden"

log ""
log "=== SCHRITT 2: SCRIPTS INTEGRIEREN ==="

# Erstelle usr/local/bin Verzeichnis
mkdir -p "$MOODE_SOURCE/usr/local/bin"

log "Kopiere Custom Scripts..."
cp "$COMPONENTS_DIR/scripts/xserver-ready.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/xserver-ready.sh" && \
   log "✅ xserver-ready.sh kopiert"

cp "$COMPONENTS_DIR/scripts/start-chromium-clean.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/start-chromium-clean.sh" && \
   log "✅ start-chromium-clean.sh kopiert"

# worker.php Patch vorbereiten (wird später angewendet)
cp "$COMPONENTS_DIR/scripts/worker-php-patch.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/worker-php-patch.sh" && \
   log "✅ worker-php-patch.sh kopiert"

# I2C Stabilization Scripts
cp "$COMPONENTS_DIR/scripts/i2c-stabilize.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/i2c-stabilize.sh" && \
   log "✅ i2c-stabilize.sh kopiert"

cp "$COMPONENTS_DIR/scripts/i2c-monitor.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/i2c-monitor.sh" && \
   log "✅ i2c-monitor.sh kopiert"

cp "$COMPONENTS_DIR/scripts/audio-optimize.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/audio-optimize.sh" && \
   log "✅ audio-optimize.sh kopiert"

cp "$COMPONENTS_DIR/scripts/pcm5122-oversampling.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/pcm5122-oversampling.sh" && \
   log "✅ pcm5122-oversampling.sh kopiert"

cp "$COMPONENTS_DIR/scripts/peppymeter-extended-displays.py" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/peppymeter-extended-displays.py" && \
   log "✅ peppymeter-extended-displays.py kopiert"

# Network IP Fix Script (avoid 142/143 repeater IPs)
cp "$COMPONENTS_DIR/scripts/fix-network-ip.sh" \
   "$MOODE_SOURCE/usr/local/bin/" && \
   chmod +x "$MOODE_SOURCE/usr/local/bin/fix-network-ip.sh" && \
   log "✅ fix-network-ip.sh kopiert"

# Copy Flat EQ preset and handler
mkdir -p "$MOODE_SOURCE/www/command"
cp "$COMPONENTS_DIR/presets/ghettoblaster-flat-eq.json" \
   "$MOODE_SOURCE/www/command/" && \
   log "✅ ghettoblaster-flat-eq.json kopiert"

# Note: ghettoblaster-flat-eq.php is already in moode-source/www/command/
# (created during development, will be included in build)
if [ -f "$MOODE_SOURCE/www/command/ghettoblaster-flat-eq.php" ]; then
    log "✅ ghettoblaster-flat-eq.php gefunden"
else
    log "⚠️  ghettoblaster-flat-eq.php wird beim Build erstellt"
fi

log ""
log "=== SCHRITT 3: CONFIG TEMPLATES INTEGRIEREN ==="

# Backup vorhandener config.txt.overwrite
if [ -f "$MOODE_SOURCE/boot/firmware/config.txt.overwrite" ]; then
    cp "$MOODE_SOURCE/boot/firmware/config.txt.overwrite" \
       "$MOODE_SOURCE/boot/firmware/config.txt.overwrite.backup"
    log "✅ Backup erstellt: config.txt.overwrite.backup"
fi

# Erstelle Custom config.txt.overwrite basierend auf Template
log "Erstelle Custom config.txt.overwrite..."
cat > "$MOODE_SOURCE/boot/firmware/config.txt.overwrite" << 'CONFIG_EOF'
#########################################
# Ghettoblaster Custom Build
# This file is managed by moOde
#########################################

# Device filters
[cm4]
otg_mode=1
[pi4]
hdmi_force_hotplug:0=1
hdmi_force_hotplug:1=1
hdmi_enable_4kp60=0
[pi5]
# Pi 5 specific settings
[all]
dtoverlay=vc4-kms-v3d-pi5,noaudio
max_framebuffers=2
display_auto_detect=1
disable_fw_kms_setup=1
arm_64bit=1

# Ghettoblaster Display Settings
disable_overscan=1
display_rotate=0
hdmi_group=2
hdmi_mode=87
hdmi_cvt=1280 400 60 6 0 0 0
# Force landscape orientation
hdmi_force_mode=1

# General settings
arm_boost=0
disable_splash=1
hdmi_drive=2
hdmi_blanking=1
hdmi_force_edid_audio=1
hdmi_force_hotplug=1
# hdmi_group=0 entfernt - Konflikt mit hdmi_group=2 oben (Pi 5 benötigt hdmi_group=2)
dtparam=i2c_arm=on
dtparam=i2c_arm_baudrate=100000
dtparam=i2s=on
dtparam=audio=on

# Ghettoblaster Audio - HiFiBerry AMP100
dtoverlay=hifiberry-amp100,automute
force_eeprom_read=0

# Ghettoblaster Touchscreen - FT6236 (wird von Service geladen)
# dtoverlay=ft6236 (NICHT hier, wird von ft6236-delay.service geladen)

# Do not alter this section
# Integrated adapters
#dtoverlay=disable-bt
#dtoverlay=disable-wifi
# PCI Express
#dtparam=pciex1
#dtparam=pciex1_gen=3
# Pi Touch1
#dtoverlay=vc4-kms-dsi-7inch,invx,invy
# Fan speed
#dtparam=fan_temp0=50000,fan_temp0_hyst=5000,fan_temp0_speed=75
CONFIG_EOF

log "✅ config.txt.overwrite erstellt"

log ""
log "=== SCHRITT 4: WORKER.PHP PATCH VORBEREITEN ==="

# Prüfe ob worker.php existiert
if [ -f "$MOODE_SOURCE/var/www/daemon/worker.php" ]; then
    log "✅ worker.php gefunden"
    
    # Backup erstellen
    cp "$MOODE_SOURCE/var/www/daemon/worker.php" \
       "$MOODE_SOURCE/var/www/daemon/worker.php.backup"
    log "✅ Backup erstellt: worker.php.backup"
    
    # Patch anwenden (wenn noch nicht vorhanden)
    if ! grep -q "Ghettoblaster: display_rotate=0" "$MOODE_SOURCE/var/www/daemon/worker.php"; then
        log "Wende worker.php Patch an..."
        "$MOODE_SOURCE/usr/local/bin/worker-php-patch.sh"
        log "✅ worker.php Patch angewendet"
    else
        log "✅ worker.php Patch bereits angewendet"
    fi
else
    log "⚠️  worker.php nicht gefunden (wird beim Build erstellt)"
fi

log ""
log "=== SCHRITT 5: OVERLAYS VORBEREITEN ==="

# Erstelle Verzeichnis für Overlays
mkdir -p "$MOODE_SOURCE/boot/firmware/overlays"

log "Kopiere Custom Overlays..."
cp "$COMPONENTS_DIR/overlays/ghettoblaster-ft6236.dts" \
   "$MOODE_SOURCE/boot/firmware/overlays/" && \
   log "✅ FT6236 Overlay kopiert"

cp "$COMPONENTS_DIR/overlays/ghettoblaster-amp100.dts" \
   "$MOODE_SOURCE/boot/firmware/overlays/" && \
   log "✅ AMP100 Overlay kopiert"

log ""
log "=== SCHRITT 6: POST-BUILD SCRIPT ERSTELLEN ==="

# Erstelle Post-Build Script für Overlay-Kompilierung
cat > "$MOODE_SOURCE/usr/local/bin/post-build-overlays.sh" << 'POSTBUILD_EOF'
#!/bin/bash
# Ghettoblaster - Post-Build Overlay Kompilierung
# Kompiliert Custom Overlays zu DTBO

OVERLAYS_DIR="/boot/firmware/overlays"
DTBO_DIR="/boot/firmware/overlays"

# Kompiliere FT6236 Overlay
if [ -f "$OVERLAYS_DIR/ghettoblaster-ft6236.dts" ]; then
    dtc -@ -I dts -O dtb -o "$DTBO_DIR/ghettoblaster-ft6236.dtbo" \
        "$OVERLAYS_DIR/ghettoblaster-ft6236.dts" 2>/dev/null && \
        echo "✅ FT6236 Overlay kompiliert" || \
        echo "⚠️  FT6236 Overlay Kompilierung fehlgeschlagen"
fi

# Kompiliere AMP100 Overlay
if [ -f "$OVERLAYS_DIR/ghettoblaster-amp100.dts" ]; then
    dtc -@ -I dts -O dtb -o "$DTBO_DIR/ghettoblaster-amp100.dtbo" \
        "$OVERLAYS_DIR/ghettoblaster-amp100.dts" 2>/dev/null && \
        echo "✅ AMP100 Overlay kompiliert" || \
        echo "⚠️  AMP100 Overlay Kompilierung fehlgeschlagen"
fi
POSTBUILD_EOF

chmod +x "$MOODE_SOURCE/usr/local/bin/post-build-overlays.sh"
log "✅ Post-Build Script erstellt"

log ""
log "=== SCHRITT 7: VERIFIKATION ==="

log "Integrierte Services:"
ls -1 "$MOODE_SOURCE/lib/systemd/system/" | grep -E "localdisplay|xserver-ready|ft6236|peppymeter" | tee -a "$LOG_FILE"

log ""
log "Integrierte Scripts:"
ls -1 "$MOODE_SOURCE/usr/local/bin/" | grep -E "xserver-ready|start-chromium|worker-php|post-build" | tee -a "$LOG_FILE"

log ""
log "Config Template:"
grep -E "display_rotate|ghettoblaster|amp100" "$MOODE_SOURCE/boot/firmware/config.txt.overwrite" | head -10 | tee -a "$LOG_FILE"

log ""
log "=== ZUSAMMENFASSUNG ==="
log "✅ Custom Services integriert"
log "✅ Custom Scripts integriert"
log "✅ Config Template integriert"
log "✅ Overlays vorbereitet"
log "✅ worker.php Patch vorbereitet"
log ""
log "moOde Source ist bereit für Custom Build!"

echo "==========================================" | tee -a "$LOG_FILE"
echo "✅ INTEGRATION ABGESCHLOSSEN" | tee -a "$LOG_FILE"
echo "==========================================" | tee -a "$LOG_FILE"

