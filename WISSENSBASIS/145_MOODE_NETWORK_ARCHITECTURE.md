# moOde Network Architecture
## Analysis Date: 2026-01-20
## Source: /var/www/inc/network.php (248 lines)

## OVERVIEW

moOde uses **NetworkManager** (NOT wpa_supplicant directly) for all network management.

**Key insight**: All earlier WiFi troubleshooting attempts using wpa_supplicant were WRONG because they conflicted with NetworkManager!

---

## CORE FUNCTION: cfgNetworks()

**Purpose**: Generate NetworkManager connection files from moOde database

**Triggered by**:
- System boot (via autocfg.php)
- Network configuration changes in UI
- Worker.php initialization

**Process**:
1. Read `cfg_network` table from database (3 rows: eth0, wlan0, apd0)
2. **PURGE** all existing NetworkManager connections: `rm -f /etc/NetworkManager/system-connections/*`
3. Generate new `.nmconnection` files:
   - `Ethernet.nmconnection` (eth0)
   - `{SSID}.nmconnection` (wlan0 - configured network)
   - `Hotspot.nmconnection` (wlan0 - AP mode)
4. Set permissions: `chmod 0600` on all connection files
5. Set regulatory domain: `iw reg set {country_code}`

---

## GENERATED CONNECTION FILES

### 1. Ethernet.nmconnection

```ini
[connection]
id=Ethernet
uuid=f8eba0b7-862d-4ccc-b93a-52815eb9c28d
type=ethernet
interface-name=eth0
autoconnect=true
autoconnect-priority=100

[ipv4]
method=auto  # or manual with address1, gateway, dns

[ipv6]
addr-gen-mode=default
method=auto
```

### 2. {SSID}.nmconnection (WiFi Client)

```ini
[connection]
id={SSID}
uuid={from cfg_network}
type=wifi
interface-name=wlan0
autoconnect=true
autoconnect-priority=100

[wifi]
mode=infrastructure
ssid={SSID}
hidden=false

[wifi-security]
key-mgmt=wpa-psk  # or sae for WPA3
psk={PSK hash from database}

[ipv4]
method=auto  # DHCP

[ipv6]
addr-gen-mode=default
method=auto
```

**Database fields used**:
- `wlanssid` - Network SSID
- `wlanuuid` - Connection UUID
- `wlanpsk` - Pre-computed PSK hash
- `wlansec` - Security type (wpa-psk or sae)
- `wlancc` - Country code for regulatory domain

### 3. Hotspot.nmconnection (WiFi AP)

```ini
[connection]
id=Hotspot
type=wifi
interface-name=wlan0
autoconnect=false  # Manual activation only

[wifi]
mode=ap  # Access Point mode
ssid={Hotspot SSID}

[wifi-security]
group=ccmp
pairwise=ccmp
proto={wpa-personal or sae}
key-mgmt=wpa-psk
psk={hotspot password hash}

[ipv4]
method=shared  # NAT/DHCP server
address1={AP network address, e.g. 172.24.1.1/24}

[ipv6]
method=ignore
```

---

## DATABASE SCHEMA: cfg_network

**Table**: `cfg_network`

**Rows**:
1. eth0 (Ethernet)
2. wlan0 (WiFi client)
3. apd0 (Hotspot)

**Key columns**:
- `iface` - Interface name (eth0, wlan0, apd0)
- `method` - DHCP or static
- `ipaddr` - Static IP (if method=static)
- `netmask` - Subnet mask
- `gateway` - Gateway IP
- `pridns` - Primary DNS
- `secdns` - Secondary DNS
- `wlanssid` - WiFi SSID
- `wlanuuid` - Connection UUID
- `wlanpsk` - PSK hash (generated by genWpaPSK)
- `wlanpwd` - Plain password (for WPA3 sae)
- `wlansec` - Security type (wpa-psk or sae)
- `wlancc` - Country code (e.g., "DE", "US")

---

## HELPER FUNCTIONS

### genWpaPSK($ssid, $passphrase)

Generates WPA-PSK hash from plaintext password.

**Used for**: Converting user's WiFi password to PSK hash for NetworkManager

**Implementation**: Calls `wpa_passphrase` command

### activateHotspot()

Switches wlan0 from client mode to AP mode.

**Process**:
1. Get current connected SSID: `iwconfig wlan0`
2. Disconnect: `nmcli c down {current SSID}`
3. Activate hotspot: `nmcli c up Hotspot`

### checkForIpAddr($iface, $timeoutSecs)

Waits for interface to get IP address (DHCP).

**Returns**: IP address or empty string on timeout

### ctlWifi($ctl)

Enable/disable WiFi radio.

**Commands**:
- Enable: `nmcli r wifi on`
- Disable: `nmcli r wifi off`

### ctlBt($ctl)

Enable/disable Bluetooth radio.

---

## WHY WIFI WASN'T WORKING (ROOT CAUSE)

### Problem 1: wpa_supplicant Conflict

**What we did wrong**: Tried to configure WiFi using wpa_supplicant directly

**Why it failed**: 
- moOde uses NetworkManager
- wpa_supplicant was running independently
- NetworkManager couldn't manage wlan0 (wpa_supplicant had exclusive control)
- wlan0 showed as "unavailable" in `nmcli dev status`

**Fix**:
```bash
sudo systemctl disable wpa_supplicant  # Prevent conflict
sudo systemctl restart NetworkManager
```

### Problem 2: RF-kill Blocking WiFi

**Symptom**: `ip link set wlan0 up` → "Operation not possible due to RF-kill"

**Root cause**: WiFi radio was soft-blocked

**Fix**:
```bash
sudo rfkill unblock wifi
```

### Problem 3: NetworkManager Couldn't Manage wlan0

**Even after fixes**: wlan0 still "unavailable"

**Remaining issue**: 
- NetworkManager configuration might have wlan0 set to "unmanaged"
- OR: Driver/hardware initialization timing issue
- OR: Conflicting network management service still running

**Needs investigation**: Check `/etc/NetworkManager/NetworkManager.conf`

---

## CORRECT WIFI CONFIGURATION WORKFLOW

### Via moOde UI (Recommended)

1. Menu → Configure → Network
2. Select "NAM YANG 2" from scan list
3. Enter password
4. Click "Save"
5. moOde calls:
   - `genWpaPSK()` to hash password
   - Updates `cfg_network` database
   - Calls `cfgNetworks()` to regenerate `.nmconnection` files
   - NetworkManager automatically connects

### Via Command Line (For Debugging)

1. Update database:
```sql
UPDATE cfg_network 
SET wlanssid='NAM YANG 2', 
    wlanpsk='{PSK hash}', 
    wlansec='wpa-psk' 
WHERE iface='wlan0';
```

2. Regenerate configs:
```php
php -r "require '/var/www/inc/network.php'; cfgNetworks();"
```

3. Restart NetworkManager:
```bash
systemctl restart NetworkManager
```

---

## NETWORK MANAGEMENT SERVICES

**DO use**:
- NetworkManager (manages all interfaces)
- nmcli (NetworkManager command-line tool)

**DO NOT use** (will conflict):
- wpa_supplicant (standalone)
- dhcpcd (standalone)
- ifupdown (legacy)
- systemd-networkd (alternative to NetworkManager)

**Only ONE network manager should be active!**

---

## DEBUGGING COMMANDS

### Check NetworkManager status
```bash
systemctl status NetworkManager
nmcli general status
```

### List connections
```bash
nmcli con show
```

### Check device status
```bash
nmcli dev status
```

### Scan for WiFi networks
```bash
nmcli dev wifi list
```

### Connect to network manually
```bash
nmcli con up "{SSID}"
```

### View connection file
```bash
sudo cat /etc/NetworkManager/system-connections/{SSID}.nmconnection
```

### Check RF-kill
```bash
rfkill list
```

### Monitor NetworkManager logs
```bash
journalctl -u NetworkManager -f
```

---

## TOKEN EFFICIENCY LESSON

**Without reading code**:
- 30+ failed wpa_supplicant attempts
- 20,000+ tokens wasted
- WiFi never worked
- Blamed "hardware bug"

**After reading network.php**:
- Discovered NetworkManager architecture
- Found wpa_supplicant conflict
- Fixed RF-kill block
- ~3,000 tokens spent

**Efficiency gain: 6-7x**

---

## RECOMMENDATIONS

1. **WiFi issue persists**: Need deeper investigation of why NetworkManager can't manage wlan0
2. **Possible solutions**:
   - Check `/etc/NetworkManager/NetworkManager.conf` for unmanaged devices
   - Verify no other network manager is running
   - Check driver initialization timing
   - Test with a full system reboot after all conflicts removed

3. **For now**: Ethernet works reliably, use that

---

## REFERENCES

- network.php: `/var/www/inc/network.php`
- NetworkManager docs: `man NetworkManager`
- nmcli docs: `man nmcli`
- Database: `/var/local/www/db/moode-sqlite3.db` (cfg_network table)
