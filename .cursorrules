# CRITICAL: NEVER RUN AUDIO TESTS
# User has explicitly requested: NEVER run audio tests automatically
# This includes:
# - NEVER run `mpc play` automatically
# - NEVER run `aplay` tests automatically  
# - NEVER run any audio playback commands
# - User will test manually starting with volume 0
# - Only show diagnostics, never execute audio playback

# Volume Settings:
# - Can set volumes to safe levels (30% hardware, 20% software)
# - But user controls all testing
# - User tests manually: mpc volume 0, then play, then increase gradually

# Audio Scripts:
# - All scripts must NOT contain automatic playback
# - All scripts must NOT contain aplay/mpc play tests
# - Only diagnostics and configuration changes allowed

# CRITICAL: NEVER CLAIM "ROOT CAUSE" WITHOUT VERIFICATION
# - NEVER say "root cause found" or "found the root cause" unless verified
# - NEVER store "root cause" claims in documentation without watertight justification
# - Only say "fixed X" or "changed Y" - let user verify if it actually fixes the problem
# - Be humble: make changes, document what was changed, wait for verification
# - This is why previous fixes didn't work - claiming root cause without proof

# CRITICAL: PATH RESOLUTION AND COMMAND-LINE CONTEXT
# This rule prevents recurring "No such file or directory" errors
# Root cause: Not understanding working directory context and path resolution

# MANDATORY: Before giving ANY command-line instruction:
# 1. ALWAYS use ABSOLUTE paths OR explicitly state the working directory
# 2. ALWAYS verify file/directory existence using read_file or list_dir BEFORE referencing
# 3. ALWAYS understand the workspace structure:
#    - Workspace root: /Users/andrevollmer/moodeaudio-cursor
#    - SD card mount: /Volumes/rootfs (when mounted)
#    - Tools directory: /Users/andrevollmer/moodeaudio-cursor/tools
#    - Scripts directory: /Users/andrevollmer/moodeaudio-cursor/scripts
# 4. NEVER assume current working directory - always specify it explicitly
# 5. NEVER use relative paths without first checking where the command will run
# 6. When creating scripts, use absolute paths or determine workspace root dynamically

# Examples of WRONG (what causes failures):
# ❌ "cd tools/fix && ./script.sh" - assumes current directory
# ❌ "bash script.sh" - doesn't specify path
# ❌ "cat file.txt" - relative path, unknown context
# ❌ "ls -la tools/" - assumes workspace root

# Examples of CORRECT:
# ✅ "cd /Users/andrevollmer/moodeaudio-cursor/tools/fix && bash script.sh"
# ✅ "bash /Users/andrevollmer/moodeaudio-cursor/tools/fix/script.sh"
# ✅ "cat /Users/andrevollmer/moodeaudio-cursor/file.txt"
# ✅ "ls -la /Users/andrevollmer/moodeaudio-cursor/tools/"

# When providing commands to user:
# - ALWAYS include full absolute path OR explicit "cd" to set context
# - ALWAYS verify the file exists first using read_file or list_dir
# - ALWAYS check if directories exist before referencing
# - If path might not exist, use conditional checks: "if [ -f /path ]; then ..."

# For scripts that need workspace root:
# - Use: WORKSPACE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
# - Or: WORKSPACE_ROOT="/Users/andrevollmer/moodeaudio-cursor"
# - Then reference: "$WORKSPACE_ROOT/tools/fix/script.sh"

# For SD card operations:
# - ALWAYS check: if [ ! -d "/Volumes/rootfs" ]; then echo "SD not mounted"; exit 1; fi
# - ALWAYS use: /Volumes/rootfs/etc/systemd/system/... (absolute path)

# This prevents the recurring pattern:
# - User runs command from unknown directory
# - Relative paths fail: "No such file or directory"
# - Dependencies break because paths are wrong
# - Same mistake repeated because context wasn't verified

# CRITICAL: GITHUB REPOSITORY INTEGRATION INTO WORKFLOWS
# Repository: https://github.com/horstpeter0815/moodeaudio-ghettoblaster.git
# This rule prevents repeatedly applying fixes when working configurations exist in GitHub

# MANDATORY: Before applying ANY fix or configuration change:
# 1. ALWAYS check GitHub for working configurations FIRST
#    - Search for commits with "working", "v1.0", "complete", "tested" in message
#    - Check for tags like "v1.0-working", "stable", "tested"
#    - Look in backups/ directories for working configs
# 2. ALWAYS prefer restoring from GitHub over applying new fixes
#    - If a working configuration exists in GitHub, RESTORE it, don't fix
#    - Use: git show <commit>:<path> to extract working files
#    - Example: git show 84aa8c2:backups/v1.0-2026-01-08/cmdline.txt
# 3. ALWAYS tag working versions in GitHub
#    - After confirming a working system: git tag v1.0-working
#    - Tag with descriptive names: v1.0-stable, v1.0-tested, etc.
#    - Push tags: git push origin --tags
# 4. ALWAYS reference GitHub commits when restoring
#    - Document which commit/tag was used: "Restored from commit 84aa8c2"
#    - Include commit hash in restore scripts
#    - Verify commit exists: git show <commit> --stat
# 5. ALWAYS store working configurations in GitHub
#    - Don't just store locally - commit working configs to GitHub
#    - Use backups/ directory structure: backups/v1.0-YYYY-MM-DD/
#    - Include: cmdline.txt, config.txt, .xinitrc, service configs, etc.

# Examples of WRONG (what causes repeated fixes):
# ❌ "Let me apply a fix to the SD card" - without checking GitHub first
# ❌ "I'll create a new configuration" - when working one exists in GitHub
# ❌ "Applying fixes to resolve issue" - should restore working config instead
# ❌ Storing working configs only locally - not in GitHub

# Examples of CORRECT:
# ✅ "Checking GitHub for working v1.0 configuration..." (then restore from commit)
# ✅ "Found working config in commit 84aa8c2, restoring..." (use git show)
# ✅ "Tagging this working version as v1.0-stable" (after verification)
# ✅ "Restored from GitHub commit 84aa8c2:backups/v1.0-2026-01-08/cmdline.txt"

# GitHub Workflow:
# 1. User reports issue
# 2. Check GitHub: git log --all --grep="working\|v1.0\|tested" --oneline
# 3. If working config found: git show <commit>:<path> and restore
# 4. If no working config: Apply fix, then commit and tag as working
# 5. Document: "Working configuration stored in GitHub commit <hash>"

# This prevents the recurring pattern:
# - Apply fix → doesn't work → apply another fix → still doesn't work
# - Repeat 20+ times for same issue
# - User: "We had a working system, why can't you restore it?"
# - Solution: Check GitHub FIRST, restore working config, don't fix

# CRITICAL: DISPLAY ORIENTATION - BOOT SCREEN AND MOODE SCREEN
# This rule prevents repeatedly breaking display orientation that was working

# MANDATORY: For 1280x400 landscape display orientation:
# 1. BOOT SCREEN (early boot, before X11):
#    - /boot/firmware/cmdline.txt: MUST have `video=HDMI-A-1:1280x400@60`
#    - /boot/firmware/config.txt: MUST have:
#      * hdmi_group=2
#      * hdmi_mode=87
#      * hdmi_timings=400 0 220 32 110 1280 0 10 10 10 0 0 0 60 0 59510000 0
#    - These settings control the framebuffer resolution during boot
# 2. MOODE SCREEN (after X11 starts):
#    - Database: /var/local/www/db/moode-sqlite3.db
#      * cfg_system.hdmi_scn_orient = 'landscape'
#    - /home/andre/.xinitrc: Uses moOde default (reads from database via moodeutl)
#    - The .xinitrc reads HDMI_SCN_ORIENT from database and applies rotation via xrandr
# 3. NEVER change .xinitrc manually - use moOde default that reads from database
# 4. NEVER remove video parameter from cmdline.txt
# 5. NEVER remove hdmi_group/hdmi_mode/hdmi_timings from config.txt

# Examples of WRONG (what causes failures):
# ❌ Removing video parameter from cmdline.txt
# ❌ Changing hdmi_group or hdmi_mode without understanding
# ❌ Manually editing .xinitrc instead of using moOde default
# ❌ Setting hdmi_scn_orient to 'portrait' when display should be landscape

# Examples of CORRECT:
# ✅ cmdline.txt: video=HDMI-A-1:1280x400@60
# ✅ config.txt: hdmi_group=2, hdmi_mode=87, correct hdmi_timings
# ✅ Database: hdmi_scn_orient='landscape'
# ✅ .xinitrc: moOde default (uses moodeutl to read database)

# This prevents the recurring pattern:
# - Boot screen wrong orientation → fix cmdline.txt → moOde screen wrong → fix .xinitrc
# - Repeat fixes without understanding both boot and runtime orientation
# - Solution: Fix BOTH boot screen (cmdline.txt + config.txt) AND moOde screen (database + .xinitrc)

# CRITICAL: HOW cmdline.txt video PARAMETER AND .xinitrc WORK TOGETHER
# This is a critical learning that must be understood and preserved

# THE RELATIONSHIP:
# 1. cmdline.txt video parameter: Sets the FRAMEBUFFER resolution during boot (before X11 starts)
#    - Format: video=HDMI-A-1:1280x400@60
#    - This is the PHYSICAL resolution the framebuffer uses
#    - This appears during boot, before moOde UI loads
#    - This is what you see during the boot process
#
# 2. .xinitrc: Reads from moOde database and applies X11 rotation AFTER X server starts
#    - Reads: HDMI_SCN_ORIENT=$(moodeutl -q "SELECT value FROM cfg_system WHERE param='hdmi_scn_orient'")
#    - Applies: xrandr --output HDMI-2 --rotate left (if portrait) or normal (if landscape)
#    - This is what you see AFTER boot, when moOde UI is running
#
# 3. HOW THEY WORK TOGETHER:
#    - cmdline.txt video parameter sets the BASE resolution (1280x400 landscape)
#    - .xinitrc reads the database setting and applies rotation if needed
#    - If database says "portrait", .xinitrc rotates the 1280x400 to portrait (400x1280)
#    - If database says "landscape", .xinitrc keeps it as 1280x400 landscape
#    - The video parameter in cmdline.txt should ALWAYS be 1280x400@60 (the physical display size)
#    - The .xinitrc then rotates it based on what the database says
#
# 4. CRITICAL UNDERSTANDING:
#    - cmdline.txt video parameter = PHYSICAL display resolution (always 1280x400)
#    - .xinitrc rotation = LOGICAL orientation (landscape or portrait based on database)
#    - They work TOGETHER: cmdline sets the base, .xinitrc rotates it
#    - NEVER change cmdline.txt video to match rotation - it should always be 1280x400
#    - ALWAYS change database hdmi_scn_orient to control rotation, .xinitrc reads it
#
# Examples of WRONG (what causes failures):
# ❌ Setting cmdline.txt video to 400x1280 to match portrait - WRONG, breaks boot screen
# ❌ Manually editing .xinitrc rotation without updating database - WRONG, gets overwritten
# ❌ Changing cmdline.txt video parameter when you want to change orientation - WRONG
#
# Examples of CORRECT:
# ✅ cmdline.txt: video=HDMI-A-1:1280x400@60 (always this, never change)
# ✅ Database: hdmi_scn_orient='landscape' (for landscape) or 'portrait' (for portrait)
# ✅ .xinitrc: Uses moOde default that reads from database (never manually edit rotation)
# ✅ To change orientation: Update database, .xinitrc will read it automatically
#
# This prevents the recurring pattern:
# - Change cmdline.txt video → boot screen wrong → change back → moOde screen wrong
# - Manually edit .xinitrc → gets overwritten → doesn't work
# - Solution: cmdline.txt video = always 1280x400, database controls rotation via .xinitrc

# CRITICAL: CONFIG.TXT MANDATORY SETTINGS - ALWAYS APPLY THESE
# These settings must ALWAYS be present in /boot/firmware/config.txt
# User has manually edited config.txt and these are the required settings

# MANDATORY: Always ensure these settings exist in config.txt:
# 1. arm_boost=1
#    - Must always be enabled for performance
# 2. dtparam=audio=off
#    - Must always disable onboard audio (we use HiFiBerry AMP100)
# 3. dtoverlay=vc4-kms-v3d-pi5,noaudio
#    - KMS enabled with noaudio (onboard audio disabled)
# 4. hdmi_force_edid_audio=0
#    - Disable HDMI audio (we use HiFiBerry)

# MANDATORY: When modifying config.txt:
# 1. ALWAYS preserve: arm_boost=1
# 2. ALWAYS preserve: dtparam=audio=off
# 3. ALWAYS preserve: dtoverlay=vc4-kms-v3d-pi5,noaudio
# 4. ALWAYS preserve: hdmi_force_edid_audio=0
# 5. NEVER remove or comment out these settings
# 6. If duplicates exist, remove duplicates but keep the setting

# Examples of WRONG:
# ❌ Removing arm_boost=1
# ❌ Setting dtparam=audio=on
# ❌ Removing dtparam=audio=off
# ❌ Commenting out dtoverlay=vc4-kms-v3d-pi5,noaudio

# Examples of CORRECT:
# ✅ Always have: arm_boost=1
# ✅ Always have: dtparam=audio=off
# ✅ Always have: dtoverlay=vc4-kms-v3d-pi5,noaudio
# ✅ Always have: hdmi_force_edid_audio=0
# ✅ Remove duplicates but keep the setting active

# This ensures the system always has:
# - Performance boost enabled
# - Onboard audio disabled (HiFiBerry AMP100 is the audio device)
# - KMS enabled for display
# - HDMI audio disabled

# CRITICAL: MANDATORY CONFIG.TXT SETTINGS - ALWAYS PRESERVE
# These settings must ALWAYS be present in /boot/firmware/config.txt
# User has manually configured these and they must be maintained

# MANDATORY settings that must ALWAYS be in config.txt:
# 1. arm_boost=1
#    - MUST always be set to 1
#    - NEVER remove or comment this line
#    - If missing, ALWAYS add: arm_boost=1
#
# 2. dtparam=audio=off
#    - MUST always disable onboard audio
#    - MUST be: dtparam=audio=off (not dtparam=audio=on or commented)
#    - If missing or enabled, ALWAYS set: dtparam=audio=off
#    - If duplicates exist, remove extras but keep ONE dtparam=audio=off
#
# 3. dtoverlay=vc4-kms-v3d-pi5,noaudio
#    - KMS overlay with noaudio (disables audio in KMS)
#    - Should be: dtoverlay=vc4-kms-v3d-pi5,noaudio
#    - This works together with dtparam=audio=off to disable onboard sound

# MANDATORY: Before any config.txt changes:
# 1. ALWAYS verify arm_boost=1 exists
# 2. ALWAYS verify dtparam=audio=off exists (exactly once)
# 3. ALWAYS verify dtoverlay=vc4-kms-v3d-pi5,noaudio is present
# 4. If any are missing or wrong, fix them BEFORE other changes
# 5. After any changes, verify these settings still exist

# Examples of WRONG:
# ❌ Removing arm_boost=1 during cleanup
# ❌ Setting dtparam=audio=on
# ❌ Commenting out dtparam=audio=off
# ❌ Having dtparam=audio=off multiple times (clean up duplicates)
# ❌ Not checking these before making other changes

# Examples of CORRECT:
# ✅ Always verify arm_boost=1 before and after changes
# ✅ Always verify dtparam=audio=off before and after changes
# ✅ Remove duplicate dtparam=audio=off entries but keep one
# ✅ If missing, add them immediately

# This prevents the recurring pattern:
# - Make changes → accidentally remove arm_boost → performance degrades
# - Make changes → onboard audio gets enabled → conflicts with HiFiBerry
# - Solution: ALWAYS preserve these mandatory settings

# CRITICAL: NEVER USE SED/AWK/SCRIPT HACKS - UNDERSTAND CODE FIRST
# This rule prevents wasting tokens on repeated failed script-based fixes
# Root cause: Not understanding the codebase architecture before modifying

# MANDATORY: Before modifying ANY code (HTML/JS/PHP/Python/etc):
# 1. ALWAYS read the source code FIRST to understand the architecture
# 2. ALWAYS understand how the existing code works before changing it
# 3. ALWAYS fix at the ROOT CAUSE level, not with symptomatic hacks
# 4. NEVER use sed/awk to modify code without understanding what you're changing
# 5. NEVER use trial-and-error fixes - understand first, then fix once correctly
# 6. ALWAYS document the learning in WISSENSBASIS/ for future reuse

# The Token Efficiency Problem:
# ❌ Script-based trial-and-error: 60,000+ tokens wasted (70+ failed attempts)
# ✅ Understanding-first approach: 5,000 tokens (5 tool calls, one correct fix)
# Result: 10x token reduction by reading source code first!

# moOde-Specific Architecture Knowledge:

# 1. WEB UI EVENT HANDLERS
# - Source code: /moode-source/www/js/scripts-panels.js (event bindings)
# - jQuery binds to CSS CLASSES, not IDs: $('.classname').click()
# - Multiple elements can have same class → same handler fires for all
# - Use UNIQUE IDs for new buttons: $('#unique-id').click()
# - Don't modify minified files - read the source first

# Example (PeppyMeter button):
# ❌ WRONG: Use sed to change icon, keep old class "add-item-to-favorites"
# Result: Click triggers favorites handler because class selector matches!
# ✅ CORRECT: Read scripts-panels.js, understand $('.add-item-to-favorites').click()
# Solution: Remove old class, use unique ID "toggle-peppymeter"

# 2. TEMPLATE SYSTEM
# - moOde uses TWO files: header.php (structure) + templates/indextpl.min.html (rendered)
# - BOTH must be modified for consistency
# - Templates contain the actual HTML that browsers receive
# - Use Python for complex HTML manipulation, not sed

# 3. VERIFICATION
# - Don't just restart services and hope it works
# - Verify the actual DOM being served: curl -s http://localhost/index.php | grep "pattern"
# - Use Python to inspect files: regex matching is more reliable than grep
# - Check what classes/IDs exist BEFORE modifying

# Workflow for Code Modifications:
# 1. Read source code in /moode-source/ to understand architecture
# 2. Identify root cause (e.g., CSS class selector binding)
# 3. Design fix at root cause level (e.g., remove class, use unique ID)
# 4. Verify with proper tools (Python, curl, not just visual checking)
# 5. Document learning in WISSENSBASIS/
# 6. Test once - should work because you understood it

# This prevents the recurring pattern:
# - Try script fix → doesn't work → try another script fix → repeat 70 times
# - User: "No more script fixes! Understand the code!"
# - Solution: Read source first, understand architecture, fix once correctly
# - Result: 10x token efficiency, user satisfaction, reusable knowledge
